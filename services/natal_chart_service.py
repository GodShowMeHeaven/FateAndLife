from services.openai_service import ask_openai
import logging

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def get_natal_chart(name: str, birth_date: str, birth_time: str, birth_place: str) -> str:
    """Асинхронно запрашивает у OpenAI детальный разбор натальной карты."""
    prompt = (
        f"Ты — хранитель древних астрологических знаний, способный читать тайные письмена звёзд. "
        f"Раскрой сакральный код судьбы, заключенный в натальной карте {name}, чья душа пришла в этот мир "
        f"{birth_date} в {birth_time}, под небом {birth_place}. "
        f"Опиши, как планетарные силы переплетаются в танце энергий, формируя уникальный узор судьбы: "
        f"1) Священный облик души — раскрой мистические грани личности, затаенные таланты и тайные страхи, "
        f"отраженные в положении планет и домов. "
        f"2) Космическая миссия — какую божественную задачу несет эта душа? Какие уроки пришла постичь? "
        f"Какой след должна оставить во вселенной? "
        f"3) Триада силы — расшифруй мистическое влияние Солнца (истинное 'Я'), Луны (тайная сущность) и "
        f"Асцендента (маска для мира), как они формируют основу энергетического потока судьбы. "
        f"4) Ритуалы гармонии — какие священные практики, камни, цвета, стихии и направления помогут укрепить "
        f"благоприятные аспекты карты и смягчить влияние трудных? "
        f"Говори языком символов, метафор и тайных знаний, чтобы душа почувствовала глубинный резонанс "
        f"с космическими энергиями, заключенными в её натальной карте. "
        f"Не используй Markdown-форматирование (например, ###, **, *, # и т.д.). "
    )
    response = await ask_openai(prompt)
    
    # Очищаем текст от потенциально проблемных символов
    response = ''.join(c for c in response if ord(c) < 128 or c in 'абвгдеёжзийклмнопрстуфхцчшщъыьэюяАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ\n')
    response = response.replace("\n\n", "\n").replace("  ", " ")  # Упрощаем форматирование
    
    logger.debug(f"Очищенный natal_chart_text: {response[:500]}...")  # Логируем первые 500 символов
    return response