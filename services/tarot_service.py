import random
from openai import OpenAI
from services.openai_service import ask_openai
import re
import config
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
client = OpenAI(api_key=config.OPENAI_API_KEY)

# –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç –¢–∞—Ä–æ
tarot_cards = [
    "–®—É—Ç", "–ú–∞–≥", "–í–µ—Ä—Ö–æ–≤–Ω–∞—è –ñ—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä",
    "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "–û—Ç—à–µ–ª—å–Ω–∏–∫",
    "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "–°–∏–ª–∞", "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–°–º–µ—Ä—Ç—å", "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å",
    "–î—å—è–≤–æ–ª", "–ë–∞—à–Ω—è", "–ó–≤–µ–∑–¥–∞", "–õ—É–Ω–∞", "–°–æ–ª–Ω—Ü–µ", "–°—É–¥", "–ú–∏—Ä"
]

async def get_tarot_interpretation():
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É OpenAI –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ—ë –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç."""
    card = random.choice(tarot_cards)
    prompt = (
        f"–¢—ã ‚Äî –¥—Ä–µ–≤–Ω–∏–π –º–∏—Å—Ç–∏–∫ –∫–∞—Ä—Ç –¢–∞—Ä–æ. –í —Å–≤–µ—Ç–µ —Å–≤–µ—á–µ–π —Ç–≤–æ–∏ —Ä—É–∫–∏ –∫–∞—Å–∞—é—Ç—Å—è –∫–æ–ª–æ–¥—ã, –∏ —Å–∏–ª—ã —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∫–∞—Ä—Ç—É: {card}. "
        f"–†–∞—Å–∫—Ä–æ–π –≥–ª—É–±–∏–Ω–Ω—ã–π —Å–º—ã—Å–ª –≤ —á–µ—Ç—ã—Ä—ë—Ö —Å—Ñ–µ—Ä–∞—Ö: "
        
        f"üåü –°—É–¥—å–±–∞ ‚Äî –∫–∞–∫–∏–µ –Ω–∏—Ç–∏ –ú–æ–π—Ä —Å–ø–ª–µ—Ç–∞—é—Ç—Å—è? –ö–∞–∫–∏–µ –∑–Ω–∞–∫–∏ –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ —É—Ä–æ–∫–∏ –Ω–µ—Å—ë—Ç –∫–∞—Ä—Ç–∞? "
        f"–î–æ–±–∞–≤—å –ø—Ä–æ—Ä–æ—á–µ—Å–∫–æ–µ –≤–∏–¥–µ–Ω–∏–µ –±—É–¥—É—â–µ–≥–æ. "
        
        f"üåü –õ—é–±–æ–≤—å ‚Äî –∫–∞–∫ —ç–Ω–µ—Ä–≥–∏–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Å–µ—Ä–¥–µ—á–Ω—É—é —á–∞–∫—Ä—É –∏ —Å–≤—è–∑–∏? –ö–∞–∫–∏–µ –∂–µ–ª–∞–Ω–∏—è –ø—Ä–æ–±—É–∂–¥–∞—é—Ç—Å—è? "
        
        f"üåü –í–ª–∞—Å—Ç—å –∏ –£—Å–ø–µ—Ö ‚Äî –∫–∞–∫–∏–µ –≤—Ä–∞—Ç–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–ª—è —Ä–æ—Å—Ç–∞? –ö–∞–∫–∏–µ —Ç–∞–ª–∞–Ω—Ç—ã –¥—Ä–µ–º–ª—é—Ç –≤ –ø–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–∏? "
        
        f"üåü –î—É—Ö ‚Äî –∫–∞–∫–∏–µ —ç–Ω–µ—Ä–≥–æ—Ü–µ–Ω—Ç—Ä—ã –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è? –ö–∞–∫–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —É—Å–∏–ª—è—Ç —Å–≤—è–∑—å —Å –≤—ã—Å—à–∏–º–∏ —Å–∏–ª–∞–º–∏? "
        
        f"–î–ª—è –∫–∞–∂–¥–æ–π —Å—Ñ–µ—Ä—ã –¥–∞–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–æ–≤–µ—Ç –∫–∞–∫ –¥—Ä–µ–≤–Ω–µ–µ –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–æ. "
        
        f"üîÆ –í –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞—Å–∫—Ä–æ–π —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫–∏–µ —Ç–∞–π–Ω—ã –∫–∞—Ä—Ç—ã ‚Äî —Å–≤—è–∑—å —Å –ø–ª–∞–Ω–µ—Ç–∞–º–∏, —Å—Ç–∏—Ö–∏—è–º–∏, "
        f"–∫—Ä–∏—Å—Ç–∞–ª–ª–∞–º–∏, –º–∞—Å–ª–∞–º–∏, –ª—É–Ω–Ω—ã–º–∏ —Ñ–∞–∑–∞–º–∏. –£–ø–æ–º—è–Ω–∏ —Å–≤—è—â–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ —Ä—É–Ω—ã. "
        
        f"–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏: üåü –ø–µ—Ä–µ–¥ —Å—Ñ–µ—Ä–∞–º–∏, üí° –ø–µ—Ä–µ–¥ —Å–æ–≤–µ—Ç–∞–º–∏, üîÆ –ø–µ—Ä–µ–¥ —ç–∑–æ—Ç–µ—Ä–∏–∫–æ–π. "
        f"–ü–∏—à–∏ –ø–æ—ç—Ç–∏—á–Ω–æ, –æ–±—Ä–∞–∑–Ω–æ, –∫–∞–∫ –¥—Ä–µ–≤–Ω–∏–µ –ø—Ä–æ—Ä–æ—á–µ—Å—Ç–≤–∞."
        f"–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ###, **, *, # –∏ —Ç.–¥.)."
    )
    interpretation = ''.join(c for c in interpretation if ord(c) < 128 or c in '–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø\n')
    interpretation = re.sub(r'\s+', ' ', interpretation).strip()  # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤
    interpretation = interpretation.replace('\n ', '\n')  # –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫
    logger.debug(f"–û—á–∏—â–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: {interpretation[:100]}...")
    return card, interpretation

def generate_tarot_image(card: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –¢–∞—Ä–æ —á–µ—Ä–µ–∑ OpenAI DALL¬∑E 3."""
    try:
        response = client.images.generate(
            model="dall-e-3",
            prompt=f"A mystical, ethereal Tarot card illustration of {card} in an ancient, ornate style with magical symbols, cosmic elements, and mystical energies. The image should appear as if from an ancient grimoire, with rich details, gold accents, and a sense of profound mystery. Add esoteric symbols around the edges and magical auras.",
            size="1024x1024",
            quality="standard",
            n=1
        )
        return response.data[0].url
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
        return None